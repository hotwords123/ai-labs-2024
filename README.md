# Homework1：UCT MCTS

## 快速开始

### 环境准备

更建议使用Linux系统完成作业，但MacOs和Windows也可以完成作业。
请先确保系统已经安装了C编译器（GCC/Clang，如不确定就先试试后续步骤），然后执行以下命令：

```bash
pip install -r requirements.txt
```


### 编译游戏环境

将下面的`***`替换成`gobang`和`tictactoe`并分别执行：

```bash
cd env/***/
python setup.py build_ext --inplace
```

编译成功后会在`env/***`路径下生成对应的`.so`文件，如产生警告不会影响正常运行。编译遇到疑难问题请联系助教。

如要重新编译，请先删除已编译好的`.so`文件，或者执行下面的指令强制重新生成：

```bash
python setup.py build_ext --inplace --force
```




### 对局

`/players`中定义了使用不同算法的游戏玩家，其中包括一个支持你手动操作的游戏玩家。`pit.py`中包含了对局的脚本，你可以执行以下命令测试AlphaBeta Search和随机策略对局的效果：

```bash
python -m pit
```

你可以修改`pit.py`中`if __name__=='__main__'`后的内容，更改对局双方的类型，测试单次对局和多次对局。


## 如何实现MCTS

### 环境交互

游戏环境（`env`）是维护游戏的核心逻辑、管理棋局状态、并将复杂的操作抽象成统一接口的对象。通过环境的封装，你可以轻松地对游戏进行操作、读取状态。方便起见，与我们将环境封装成了强化学习中常用的`gym`环境的风格。为了提高执行的效率，棋局的核心逻辑使用C++编写，通过cython与python部分代码对接。通过`env/***/setup.py`脚本可以编译这些环境。在使用这些环境前必须先进行编译。

以下是对环境使用方法的简要介绍：

* 你可以将一个环境（`env`）看做一个棋盘对象。在使用环境进行对局时，你首先需要使用`reset()`方法重置环境，然后让对局双方轮流使用`step()`方法采取动作，根`step()`的返回值判断游戏是否结束和胜者。
* 选择动作前，你可以使用`action_space_size`属性获取当前的棋盘有多少个可能的动作（动作从0开始编号），再通过环境的`action_mask`属性获取当前哪些状态是合法的（该属性会返回一个长度为`action_space_size`的`numpy`数组，其中每一位为1则表示该动作当前合法，反之为非法）。非法动作会被环境拒绝执行并抛出异常。

* 在棋盘类游戏中，棋盘的格子按照从上到下、从左到右的顺序从0开始编号，动作编号和棋盘格子编号对应，采取`i`号动作即意味着在`i`号格子落子（参考：`/env/tictactoe/tictactoe_env.py:19-22`）。游戏环境会在落子后自动切换游戏玩家，且默认黑子先手，你不需要指定你是黑子还是白子。这也意味着你需要注意不要在你的代码中让同色玩家连续落子，这会被环境识别为两方先后落子。

* 环境的`step()`方法可以执行一步落子，其只需要一个参数，即动作（格子）的编号。`step()`返回一个三元组，分别代表动作后棋盘的状态（`numpy`二维数组表示）、动作的奖励（浮点值）、游戏是否结束(布尔值)。游戏结束时，第三个返回值会为`True`，第二个返回值如为`1`则表示**当前采取了这一步动作的玩家**胜利,`-1`反之，平局则返回一个非0的极小值（`/env/base_env.py:10`）。如果游戏没有结束，奖励值为0。

* **请使用`fork()` 方法复制一个环境**。该方法能安全地拷贝当前的游戏局面，保证局面状态的信息完整的、彻底的、高效的复制。如果直接使用赋值语句复制环境，因为python中仅仅拷贝了对象的指针，你对新环境的修改也会修改到旧的环境，而在树搜索中，我们往往需要创建一个局面的互不干扰副本，用以探索不同的操作的后续结果。
* 如果你不关心当前的棋盘，只关心最终的胜负（奖励值），在`step()`时可以设置`return_obs=False`以跳过棋盘的拷贝，加快执行速度。

* 游戏结束后，如果要重新开始游戏，请再次调用`reset()`方法。

更多环境的属性以及使用方法，请参考`/env/base_env.py`的定义以及`/search_algo/alpha_beta_search.py`中的用法。


### MCTS实现

本次作业中，你需要补全`/mcts/uct_mcts.py`中所有标记了`TODO`的位置。本次作业的MCTS使用UCT，你可以参考[A Survey of Monte Carlo Tree Search Methods](https://repository.essex.ac.uk/4117/1/MCTS-Survey.pdf)中对UCT的描述。请按照注释的提示完成代码，不要修改其它未要求修改的代码。